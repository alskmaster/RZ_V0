{% extends 'admin/base.html' %}
{% block title %}Perfis de Coleta de Métricas{% endblock %}

{% block admin_content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Perfis de Coleta de Métricas</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('admin.add_metric_key') }}" class="btn btn-sm btn-primary">
                <i class="fas fa-plus me-1"></i> Nova Chave
            </a>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header">Descobrir no Zabbix</div>
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-md-5">
                    <label for="discover-client" class="form-label">Cliente</label>
                    <select id="discover-client" class="form-select"></select>
                </div>
                <div class="col-md-3">
                    <label for="discover-type" class="form-label">Tipo de Métrica</label>
                    <select id="discover-type" class="form-select">
                        <option value="cpu">CPU</option>
                        <option value="memory">Memória</option>
                        <option value="disk">Disco</option>
                        <option value="wifi_clients">Wi‑Fi (Clientes)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="btnDiscover" class="btn btn-secondary w-100">Descobrir</button>
                </div>
            </div>
            <div id="discover-results" class="mt-3"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            Chaves de Coleta Cadastradas
        </div>
        <div class="card-body">
            <p class="card-text">Configure aqui as chaves (keys) que o sistema deve procurar no Zabbix para cada tipo de métrica. A menor prioridade será tentada primeiro.</p>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Chave Zabbix</th>
                            <th>Prioridade</th>
                            <th>Cálculo</th>
                            <th>Descrição</th>
                            <th>Status</th>
                            <th style="width: 15%;">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key in keys %}
                        <tr>
                            <td><span class="badge bg-info">{{ key.metric_type }}</span></td>
                            <td><code>{{ key.key_string }}</code></td>
                            <td>{{ key.priority }}</td>
                            <td><span class="badge bg-light text-dark">{{ key.calculation_type.value }}</span></td>
                            <td>{{ key.description or '-' }}</td>
                            <td>
                                {% if key.is_active %}
                                    <span class="badge bg-success">Ativo</span>
                                {% else %}
                                    <span class="badge bg-secondary">Inativo</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <a href="{{ url_for('admin.edit_metric_key', key_id=key.id) }}" class="btn btn-sm btn-outline-secondary" title="Editar">
                                        <i class="fas fa-edit me-1"></i> Editar
                                    </a>
                                    <form action="{{ url_for('admin.delete_metric_key', key_id=key.id) }}" method="post" class="d-inline form-delete-metric-key" data-key-id="{{ key.id }}">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token is defined else '' }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir">
                                            <i class="fas fa-trash-alt me-1"></i> Excluir
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted p-4">Nenhum perfil de métrica cadastrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Assistente de descoberta e cadastro em lote
document.addEventListener('DOMContentLoaded', function () {
    const CSRF_TOKEN = "{{ csrf_token() if csrf_token is defined else '' }}";
    const elClient = document.getElementById('discover-client');
    const elType = document.getElementById('discover-type');
    const elBtnDiscover = document.getElementById('btnDiscover');
    const elResults = document.getElementById('discover-results');

    async function loadClients() {
        try {
            const resp = await fetch('{{ url_for('admin.metric_keys_clients') }}');
            const data = await resp.json();
            elClient.innerHTML = '';
            (data.clients || []).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                elClient.appendChild(opt);
            });
        } catch (e) {
            console.warn('[metric_keys] Falha ao carregar clientes', e);
        }
    }

    function renderCandidates(candidates, metricType) {
        if (!candidates || candidates.length === 0) {
            elResults.innerHTML = '<div class="alert alert-info mb-0">Nenhuma chave foi encontrada para os filtros selecionados.</div>';
            return;
        }
        const rows = candidates.map((c) => {
            const disabled = c.exists ? 'disabled' : '';
            const status = c.exists ? '<span class="badge bg-secondary">Já cadastrado</span>' : '<span class="badge bg-success">Novo</span>';
            return `
                <tr>
                    <td><input type="checkbox" class="form-check-input sel-cand" data-key="${c.key_string}" data-calc="${c.suggested_calc_type}" ${disabled}></td>
                    <td><code>${c.key_string}</code></td>
                    <td><span class="badge bg-light text-dark">${c.suggested_calc_type}</span></td>
                    <td>${c.found_count}</td>
                    <td><input type="number" class="form-control form-control-sm prio-cand" placeholder="auto" min="1" ${disabled}></td>
                    <td><input type="checkbox" class="form-check-input active-cand" ${disabled} ${c.exists ? '' : 'checked'}></td>
                    <td><input type="text" class="form-control form-control-sm desc-cand" placeholder="opcional" ${disabled}></td>
                    <td>${status}</td>
                </tr>`;
        }).join('');

        elResults.innerHTML = `
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th></th>
                    <th>Chave</th>
                    <th>Cálculo</th>
                    <th>Encontrados</th>
                    <th>Prioridade</th>
                    <th>Ativo</th>
                    <th>Descrição</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
            <div class="mt-2">
              <button id="btnSaveCandidates" class="btn btn-primary btn-sm">Salvar Selecionados</button>
            </div>
        `;

        const btnSave = document.getElementById('btnSaveCandidates');
        btnSave.addEventListener('click', async () => {
            const items = [];
            elResults.querySelectorAll('tbody tr').forEach(tr => {
                const sel = tr.querySelector('.sel-cand');
                if (sel && sel.checked && !sel.disabled) {
                    const prioVal = tr.querySelector('.prio-cand').value;
                    const active = tr.querySelector('.active-cand').checked;
                    const desc = tr.querySelector('.desc-cand').value;
                    items.push({
                        key_string: sel.dataset.key,
                        calculation_type: sel.dataset.calc,
                        priority: prioVal ? parseInt(prioVal) : undefined,
                        is_active: active,
                        description: desc || undefined
                    });
                }
            });

            if (items.length === 0) {
                alert('Selecione ao menos um candidato.');
                return;
            }

            try {
                const resp = await fetch('{{ url_for('admin.bulk_add_metric_keys') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({ metric_type: elType.value, items })
                });
                const data = await resp.json();
                if (!resp.ok) {
                    throw new Error(data && data.error ? data.error : 'Falha ao salvar');
                }
                const created = (data.created || []).length;
                const skipped = (data.skipped || []).length;
                alert(`Concluído. Inseridos: ${created}. Ignorados: ${skipped}.`);
                window.location.reload();
            } catch (e) {
                console.error('[metric_keys] bulk_add error', e);
                alert('Erro ao salvar em lote: ' + (e.message || e));
            }
        });
    }

    if (elClient) {
        loadClients();
    }
    if (elBtnDiscover) {
        elBtnDiscover.addEventListener('click', async () => {
            const clientId = elClient && elClient.value;
            const metricType = elType && elType.value;
            if (!clientId || !metricType) {
                alert('Selecione um cliente e o tipo de métrica.');
                return;
            }
            elResults.innerHTML = '<div class="text-muted">Consultando o Zabbix...</div>';
            try {
                const url = new URL('{{ url_for('admin.discover_metric_keys') }}', window.location.origin);
                url.searchParams.set('client_id', clientId);
                url.searchParams.set('metric_type', metricType);
                const resp = await fetch(url.toString());
                const data = await resp.json();
                if (!resp.ok) {
                    throw new Error(data && data.error ? data.error : 'Falha na descoberta');
                }
                renderCandidates(data.candidates || [], metricType);
            } catch (e) {
                console.error('[metric_keys] discover error', e);
                elResults.innerHTML = '<div class="alert alert-danger mb-0">Erro ao consultar o Zabbix.</div>';
            }
        });
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.form-delete-metric-key').forEach(function (form) {
        form.addEventListener('submit', function (e) {
            const keyId = form.getAttribute('data-key-id');
            if (!confirm('Confirma a exclusão desta chave?')) {
                e.preventDefault();
                console.debug('[metric_keys] exclusão cancelada', { keyId });
                return false;
            }
        });
    });
});
</script>
{% endblock %}
